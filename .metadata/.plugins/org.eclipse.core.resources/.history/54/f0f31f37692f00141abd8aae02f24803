package com.tdgc.cocos2dx.popup.creator.model;

import com.tdgc.cocos2dx.popup.creator.constants.Attribute;
import com.tdgc.cocos2dx.popup.creator.constants.ModelType;
import com.tdgc.cocos2dx.popup.creator.constants.Tag;
import com.tdgc.cocos2dx.popup.creator.file.FileUtils;
import com.tdgc.cocos2dx.popup.creator.global.Config;
import com.tdgc.cocos2dx.popup.creator.model.basic.CommonObject;
import com.tdgc.cocos2dx.popup.creator.model.basic.Point;
import com.tdgc.cocos2dx.popup.creator.model.basic.Size;
import com.tdgc.cocos2dx.popup.creator.utils.StringUtils;

public class Table extends CommonObject {

	public Table() {
		super();
		this.mDeclareObjectName = "CCTableView";
		this.mSuffix = "Table";
		this.mType = ModelType.TABLE;
		this.mSuper = Config.getInstance().getDefautSuper("table");
		this.mAnchorPoint = new Point(0, 0);
		this.mAnchorPointString = this.mAnchorPoint.toString();
		this.mXmlTagName = Tag.TABLE;
		
		this.mTemplateName = "CCTableView";
		this.mTemplateFile = "table.template";
	}
	
	@Override
	public String implement(boolean pInfunction) {
		StringBuilder builder = new StringBuilder("\n");
		String template = fetchTemplate(pInfunction);
		
		String parentName = Config.getInstance()
				.getDefaultParentForProperties(mParent.getType());
		if(mParent != null) {
			parentName = mParent.getName();
		}
		template = template.replace("{var_name}", mName)
			.replace("{size_name}", mSizeName)
			.replace("{position_name}", mPositionName)
			.replace("{rows}", "" + mRows)
			.replace("{columns}", "" + mColumns)
			.replace("{tab}", "\t")
			.replace("{parent_name}", parentName)
			.replace("{cell_position_name}", mCellPositionName)
			.replace("{cell_size_name}", mCellSizeName);
		
		builder.append(template);
		
		return builder.toString();
	}
	
	@Override
	public void setPositionName(String pPositionName) {
		super.setPositionName(pPositionName);
		mSizeName = mPositionName.replace("POSITION", "SIZE");
		mCellPositionName = mPositionName.replace("TABLE_POSITION", "CELL_POSITION");
		mCellSizeName = mPositionName.replace("TABLE_POSITION", "CELL_SIZE");
	}
	
	@Override
	public String declarePositions() {
		StringBuilder builder = new StringBuilder(super.declarePositions());
		FileUtils fileUtils = new FileUtils();
		String pointTemplate = fileUtils.fetchTemplate(
				getDeclaringPositionTemplateName(), 
				getPostionTemplateFilePath(), getProject());
		String sizeTemplate = fileUtils.fetchTemplate(
				getDeclaringSizeTemplateName(), 
				getSizeTemplateFilePath(), getProject());
		pointTemplate = pointTemplate.replace("{var_name}", mCellPositionName)
				.replace("{tab}", "\t");
		builder.append("\n")
			.append(pointTemplate)
			.append(sizeTemplate.replace("{tab}", "\t")
					.replace("{var_name}", mSizeName))
			.append(sizeTemplate.replace("{tab}", "\t")
					.replace("{var_name}", mCellSizeName));
		
		return builder.toString();
	}
	
	@Override
	public String implementPositions() {
		declarePositions();
		StringBuilder builder = new StringBuilder();
		String cellPositionString = mCell.getPositionString();
		String cellSizeString = mCell.getSizeString();
		
		FileUtils fileUtils = new FileUtils();
		String pointTemplate = fileUtils.fetchTemplate(
				getImplementingPositionTemplateName(), 
				getPostionTemplateFilePath(), getProject());
		
		String sizeTemplate = fileUtils.fetchTemplate(
				getImplementingSizeTemplateName(), 
				getSizeTemplateFilePath(), getProject());
		
		builder.append(pointTemplate.replace("{var_name}", mPositionName)
				.replace("{position}", mPositionString))
			.append("\t" + sizeTemplate.replace("{var_name}", mSizeName)
				.replace("{size}", mSizeString))
			.append("\t" + pointTemplate.replace("{var_name}", mCellPositionName)
				.replace("{position}", cellPositionString))
			.append("\t" + sizeTemplate.replace("{var_name}", mCellSizeName)
				.replace("{size}", cellSizeString));
		
		return builder.toString().replace("{tab}", "\t");
	}
	
	@Override
	public void setSize(String size) {
		this.mSizeString = size;
		if(size != null && size.contains(",")) {
			String[] strs = mSizeString.split(",");
			float w = Float.parseFloat(strs[0].trim());
			float h = Float.parseFloat(strs[1].trim());
			this.mSize = new Size(w, h);
		}
	}
	
	@Override
	public void setSize(Size size) {
		super.setSize(size);
		if(size != null && mCell != null) {
			mCell.setSize(size.getWidth(), (int)size.getHeight()/mRows);
		}
	}
	
	public void setRows(int pRows) {
		this.mRows = pRows;
	}
	
	public void setColumns(int pColumns) {
		this.mColumns = pColumns;
	}
	
	public int getRows() {
		return this.mRows;
	}
	
	public int getColumns() {
		return this.mColumns;
	}
	
	public void addCell(Cell cell) {
		this.mCell = cell;
		this.mCell.setTabCount(mTabCount + 1);
	}
	
	public Cell getCell() {
		return mCell;
	}
	
	public void setImage(Image img) {
		this.mImage = img;
	}
	
	public Image getImage() {
		return mImage;
	}
	
	@Override
	public CommonObject clone() {
		Table table = new Table();
		this.setAllPropertiesForObject(table);
		
		return table;
	}
	
	@Override
	public String toXML() {
		String tab = StringUtils.tab(mTabCount);
		StringBuilder builder = new StringBuilder(tab);
		builder.append("<" + mXmlTagName + " " + Attribute.ROWS + "=\"" + mRows + "\" ")
			.append(Attribute.COLUMNS + "=\" " + mColumns + "\" ")
			.append(Attribute.VISIBLE + "=\"true\" ")
			.append("\n" + tab + "\t\t" + Attribute.COMMENT + "=\"\">");
		builder.append("\n" + tab + "\t")
			.append("<" + Tag.POSITION_NAME + " " + Attribute.VALUE 
					+ "=\"" + mXmlPositionName + "\" />");
		builder.append("\n" + tab + "\t")
		.append("<" + Tag.ANCHORPOINT + " " + Attribute.VALUE 
				+ "=\"" + mAnchorPointString + "\" />");
		builder.append("\n" + tab + "\t")
		.append("<" + Tag.POSITION + " " + Attribute.VALUE 
				+ "=\"" + mPosition + "\" />");
		builder.append("\n" + tab + "\t")
		.append("<" + Tag.SIZE + " " + Attribute.VALUE 
				+ "=\"" + mSize + "\" />");
		builder.append("\n" + tab + "\t")
		.append("<" + Tag.Z_INDEX + " " + Attribute.VALUE 
				+ "=\"" + mZIndex + "\" />");
		
		builder.append("\n" + mImage.toXML());
		builder.append("\n" + mCell.toXML());
		
		builder.append("\n")
			.append(super.toXML())
			.append(tab)
			.append("</" + mXmlTagName + ">");
		
		builder.append("\n");
		
		return builder.toString();
	}
	
	protected Image mImage;
	protected String mCellSizeName;
	protected String mCellPositionName;
	protected String mSizeName;
	protected Cell mCell;
	protected int mRows;
	protected int mColumns;
	
}
